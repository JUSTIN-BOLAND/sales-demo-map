<!DOCTYPE html>
<html>
<head>
	
    <title>Clients</title>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src='https://cdnjs.cloudflare.com/ajax/libs/tabletop.js/1.5.1/tabletop.min.js'></script>

     <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"
   integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
   crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"
   integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="
   crossorigin=""></script>


   <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

	
	<script src="https://stamen-maps.a.ssl.fastly.net/js/tile.stamen.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"/>
    <link rel="stylesheet" href="https://rawgit.com/python-visualization/folium/master/folium/templates/leaflet.awesome.rotate.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
	

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css"/>
	
	<script src="script/leaflet-heat.js"></script>
	<link rel="stylesheet" href="script/Leaflet.Dialog.css"/>
	<script src="script/Leaflet.Dialog.js"></script>
	
	
	
	<script src=https://cdnjs.cloudflare.com/ajax/libs/Turf.js/5.1.5/turf.min.js></script>
	
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
	
	
	
	<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"/>
	<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"/>
	<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
	
	<script src="https://cdnjs.cloudflare.com/ajax/libs/numeral.js/2.0.6/numeral.min.js"></script>
	<script src="script/xls-export.js"></script>
</head>
<body>




<style>
/* The sidebar menu */
.sidenav {
  height: 100%; /* Full-height: remove this if you want "auto" height */
  width: 260px; /* Set the width of the sidebar */
  position: fixed; /* Fixed Sidebar (stay in place on scroll) */
  z-index: 1; /* Stay on top */
  top: 0; /* Stay at the top */
  left: 0;
  background-color: rgba(0,0,0, 0.5);
  
  overflow-x: hidden; /* Disable horizontal scroll */
  padding-top: 3px;
}
.summary > dt{
	float: left;
    clear: left;
	
    width: 160px;
   
    font-weight: normal;
    color: black;
}
h2{
	text-align:center;
	font-size: 14pt;
	margin-top: 3px;
}
dl {
    border: 1.5px double #ccc;
    padding: 0.2em;
	
  }
  dt {
	
    float: left;
    clear: left;
	
    width: 100px;
   
    font-weight: normal;
    color: green;
  }
  dt::after {
    content: ":";
  }
 
  dd {
    margin: 0 0 0 100px;
    padding: 0 0 0.5em 0;
  }
td{
	color: white;
}
.filterTitle{
	color: white;
}
</style>
<div class="sidenav">
	<table><h2 class="filterTitle">MAH Tier</h2>	
			<tr><td><input type="checkbox" name="tier" value="Tier 1" checked=checked />Tier 1</td></tr>
			<tr><td><input type="checkbox" name="tier" value="Tier 2" checked=checked/>Tier 2</td></tr>
			<tr><td><input type="checkbox" name="tier" value="Tier 3" checked=checked/>Tier 3</td></tr>		
			<tr><td><input type="checkbox" name="tier" value="Tier 4" checked=checked/>Tier 4</td></tr>
			<tr><td><input type="checkbox" name="tier" value="null" checked=checked/>No tier</td></tr>
			<tr><td></tr></td>
			<tr><td><input type="radio" name="radiotier" value="SelectAll"/>Select All</tr></td>
			<tr><td><input type="radio" name="radiotier" value="UnselectAll"/>Unselect All</tr></td>
	</table><table>
			<h2 class="filterTitle">Growth Potential</h2>	
			<tr><td><input type="checkbox" name="potential" value="Low" checked=checked />Low</td><td style="margin-top: 2px"><svg transform="translate(5,6)" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 90 90"><polygon fill="MediumOrchid" stroke="black" stroke-width="5" points="30,4,4,60,60,60" /><text x="32" y="50" text-anchor="middle" fill="black" font-weight="normal" font-size="38"></text></svg></td></tr>
			<tr><td><input type="checkbox" name="potential" value="Moderate" checked=checked />Moderate</td><td style="margin-top: 2px"><svg transform="translate(5,6)" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 90 90"><polygon fill="LightSkyBlue" stroke="black" stroke-width="5" points="30,4,4,60,60,60" /><text x="32" y="50" text-anchor="middle" fill="black" font-weight="normal" font-size="38"></text></svg></td></tr>
			<tr><td><input type="checkbox" name="potential" value="High" checked=checked />High</td><td style="margin-top: 2px"><svg transform="translate(5,6)" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 90 90"><polygon fill="PeachPuff" stroke="black" stroke-width="5" points="30,4,4,60,60,60" /><text x="32" y="50" text-anchor="middle" fill="black" font-weight="normal" font-size="38"></text></svg></td></tr>
			<tr><td><input type="checkbox" name="potential" value="null" checked=checked />No value</td><td style="margin-top: 2px"><svg transform="translate(5,6)" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 90 90"><polygon fill="white" stroke="black" stroke-width="5" points="30,4,4,60,60,60" /><text x="32" y="50" text-anchor="middle" fill="black" font-weight="normal" font-size="38"></text></svg></td></tr>
			<tr><td></tr></td>
			<tr><td><input type="radio" name="radiopotential" value="SelectAll"/>Select All</tr></td>
			<tr><td><input type="radio" name="radiopotential" value="UnselectAll"/>Unselect All</tr></td>
	</table><table>
			<h2 class="filterTitle">Sales Trend</h2>	
			<tr><td><input type="checkbox" name="trend" value="Extreme Growth (50+)" checked=checked />Extreme Growth (50+)</td><td style="margin-top: 2px"><svg transform="translate(5,6)" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 90 90"><circle cx="35" cy="38" r="33" stroke="limegreen" stroke-width="5" fill="transparent" /><text x="32" y="50" text-anchor="middle" fill="black" font-weight="normal" font-size="38"></text></svg></td></tr>
			<tr><td><input type="checkbox" name="trend" value="Major Growth (20 to 49)" checked=checked />Major Growth (20 to 49)</td><td style="margin-top: 2px"><svg transform="translate(5,6)" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 90 90"><circle cx="35" cy="38" r="33" stroke="limegreen" stroke-width="5" fill="transparent" /><text x="32" y="50" text-anchor="middle" fill="black" font-weight="normal" font-size="38"></text></svg></td></tr>
			<tr><td><input type="checkbox" name="trend" value="Moderate Growth (5 to 19)" checked=checked />Moderate Growth (5 to 19)</td><td style="margin-top: 2px"><svg transform="translate(5,6)" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 90 90"><circle cx="35" cy="38" r="33" stroke="limegreen" stroke-width="5" fill="transparent" /><text x="32" y="50" text-anchor="middle" fill="black" font-weight="normal" font-size="38"></text></svg></td></tr>
			<tr><td><input type="checkbox" name="trend" value="No Growth (-4 to 4)" checked=checked />No Growth (-4 to 4)</td><td style="margin-top: 2px"><svg transform="translate(5,6)" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 90 90"><circle cx="35" cy="38" r="33" stroke="orange" stroke-width="5" fill="transparent" /><text x="32" y="50" text-anchor="middle" fill="black" font-weight="normal" font-size="38"></text></svg></td></tr>
			<tr><td><input type="checkbox" name="trend" value="Moderate Loss (-19 to -5)" checked=checked />Moderate Loss (-19 to -5)</td><td style="margin-top: 2px"><svg transform="translate(5,6)" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 90 90"><circle cx="35" cy="38" r="33" stroke="red" stroke-width="5" fill="transparent" /><text x="32" y="50" text-anchor="middle" fill="black" font-weight="normal" font-size="38"></text></svg></td></tr>
			<tr><td><input type="checkbox" name="trend" value="Major Loss (-49 to -20)" checked=checked />Major Loss (-49 to -20)</td><td style="margin-top: 2px"><svg transform="translate(5,6)" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 90 90"><circle cx="35" cy="38" r="33" stroke="red" stroke-width="5" fill="transparent" /><text x="32" y="50" text-anchor="middle" fill="black" font-weight="normal" font-size="38"></text></svg></td></tr>
			<tr><td><input type="checkbox" name="trend" value="Extreme Loss (-50+)" checked=checked />Extreme Loss (-50+)</td><td><svg transform="translate(5,6)" xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 90 90"><circle cx="35" cy="38" r="33" stroke="red" stroke-width="5" fill="transparent" /><text x="32" y="50" text-anchor="middle" fill="black" font-weight="normal" font-size="38"></text></svg></td></tr>
			<tr><td><input type="checkbox" name="trend" value="null" checked=checked />No value</td><td></td></tr>
			<tr><td><input type="checkbox" name="trend" value="No Sales" checked=checked />No Sales</td><td></td></tr>
			<tr><td></tr></td>
			<tr><td><input type="radio" name="radiotrend" value="SelectAll"/>Select All</tr></td>
			<tr><td><input type="radio" name="radiotrend" value="UnselectAll"/>Unselect All</tr></td>
				
	</table>
	<div style="padding-top: 20px;"></div>
	
  <div style="text-align: center;"><button type="button" id="clusterButton">Cluster/Uncluster</button>	
	<button type="button" id="heatButton">Heatmap</button></div> 
	
</div>

<div id="map" style="width: 100vw; height: 100vh; z-index: 0;"></div>
 <script src="https://unpkg.com/leaflet-canvas-marker@0.2.0"></script>
<script>
	

	var clusterButton = document.getElementById("clusterButton");
	var heatButton = document.getElementById("heatButton");
	var heatActive = false;
	$.getJSON('https://api.sheety.co/d1d52423-9f56-40da-bfcf-f1cd314dacbc', function(json) {
		addPoints(json);
	});
	
	
	var map = L.map('map', {zoomControl: true}).setView([35, -99], 4);
	var scaleBar = L.control.scale({imperial: true, position: 'bottomright'}).addTo(map);
	map.zoomControl.setPosition('bottomright');
	var tonerLayer = new L.StamenTileLayer("toner-lite");
	map.addLayer(tonerLayer);
	
	
	
	
	var pointGroupLayer;
	
	
	
	function addPoints(data) {
	if (pointGroupLayer != null) {
		pointGroupLayer.remove();
	}
	
	
	var clusters;
	var clusterZoom = 18;
	pointGroupLayer = L.featureGroup();
	
	var clicks = 0; //click counter for filters
	var heat;
	var filtered = new Array();
	var summaryPoints = new Array(); //array with the points within the drawn polygon
	drawPoints();
	var drawnItems = new L.FeatureGroup();
	//map.addLayer(drawnItems);
	
	//variables used in summary
				var totTier1 = 0;
				var totTier2 = 0;
				var totTier3 = 0;
				var totTier4 = 0;
				var noTier = 0;
				var totLow = 0;
				var totMod = 0;
				var totHigh = 0;
				var noPotential = 0;
				var sales2017 = 0;
				var avg2017 = 0;
				var sales2018 = 0;
				var avg2018 = 0;
				
				//end variables in summary----------
	
	var dialog;
	var drawnAmount = 0;
	function drawPoints(){      //function called when a checkbox is clicked
		if (clicks > 0){clusters.clearLayers(); map.removeLayer(clusters);}
		if (heatActive ===true){
				map.removeLayer(heat);
			}
		clusters = L.markerClusterGroup({ disableClusteringAtZoom: clusterZoom });
	
		var markers = [];
		coordsHeat = []; //define an array to store coordinates
		
		
		
		//if (clicks > 0){map.removeLayer(heat);}
			clicks++;
			
		//map.removeLayer(pointGroupLayer)
		//pointGroupLayer = L.featureGroup().addTo(map);
		
		//filters---------------
		tierfilter = [];
		potentialfilter = [];
		trendfilter = [];
		
		 //--------tier filter-----
		$("input:checkbox[name='tier']:checked").each(function(){
				//tierfilter=[];
			if($(this).val() === "null"){tierfilter.push(null);}
			else{
			tierfilter.push($(this).val());}});
			
		function tierFilter(element) {
			var valid = tierfilter;
			return (valid.includes(element.tier));
		}
			//-----growth potential filter----
		$("input:checkbox[name='potential']:checked").each(function(){ 
			if($(this).val() === "null" || $(this).val() === "N/A"){potentialfilter.push(null);}
			else{
			potentialfilter.push($(this).val());}});
				
		function potentialFilter(element) {
			var valid = potentialfilter;
			return (valid.includes(element.sales_potential));
		}
			//-----sales trend filter----
		$("input:checkbox[name='trend']:checked").each(function(){ 
			if($(this).val() === "null" || $(this).val() === "N/A"){trendfilter.push(null);}
			else{
			trendfilter.push($(this).val());}});
				
		function trendFilter(element) {
			var valid = trendfilter;
			return (valid.includes(element.trend));
		}
		
		filtered = data.filter(tierFilter);
		filtered = filtered.filter(potentialFilter);
		filtered = filtered.filter(trendFilter);
		
		
		
		//--------------------------------------------------
		for(var row = 0; row < filtered.length; row++) {
			if (filtered[row].lat > 0){
					
					if(filtered[row].tier != null){var index = filtered[row].tier.indexOf(" ");
					var tier_no = filtered[row].tier.substr(index + 1);}else{var tier_no = "0"}
					tier_no = parseInt(tier_no);
					
					
					coordsHeat.push([filtered[row].lat, filtered[row].lon]);
					var marker = L.marker([filtered[row].lat, filtered[row].lon]).addTo(pointGroupLayer);
					marker.bindPopup("<dl>" + "<h2>Client Information	</h2><dt>Client Name </dt><dd>" + filtered[row].client + "</dd><dt>Address </dt><dd>"+ filtered[row].address+  "</dd><dt>2017 Sales </dt><dd>$." + numeral(filtered[row].sales_2017).format('0,0') + "</dd><dt>2018 Sales </dt><dd>$." + numeral(filtered[row].sales_2018).format('0,0') +"</dd><dt>Sales Trend </dt><dd>" + filtered[row].trend + "</dd><dt>Tier </dt><dd>" +tier_no+ "</dd><dt>Sales Potential </dt><dd>" +  filtered[row].sales_potential +"</dd><dt>H1 2018 $</dt><dd>"+filtered[row].h1_2018+"</dd><dt>H1 2019 $</dt><dd>"+filtered[row].h1_2019+ "</dd></dl>", 
					{
					maxWidth: 380,
					maxHeight: 700
					
					}); 
					
					
					clusters.addLayer(marker);
					map.addLayer(clusters);
					
					var trendCategory;
					// icon
					if(filtered[row].trend === "Extreme Growth (50+)" || filtered[row].trend === "Major Growth (20 to 49)" || filtered[row].trend ===  "Moderate Growth (5 to 19)"){trendCategory = 'Growing';}
					else if(filtered[row].trend === "Moderate Loss (-19 to -5)" || filtered[row].trend === "Major Loss (-49 to -20)" || filtered[row].trend === "Extreme Loss (-50+)"){trendCategory = 'Declining';}
					else{trendCategory="";}
					
					//var svg = '<svg width="400px" height="400px" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg" version="1.1"><polygon style="fill:none;stroke: black ;stroke-width:5px; opacity: 1" points="183.138438763306,172 16.8615612366939,172 100,28" /><text x="32" y="50" text-anchor="middle" fill="black" font-size="90">5</text></svg>' // insert your own svg
					if (filtered[row].sales_potential === "Low"){
						var color = "MediumOrchid";
					}
					else if (filtered[row].sales_potential === "Moderate"){
						var color = "LightSkyBlue";
					}
					else if (filtered[row].sales_potential === "High"){
						var color = "PeachPuff";
					}
					else{
						var color = "white";
					}
					
					
					if (trendCategory === "Growing"){
						var svg = '<svg xmlns="http://www.w3.org/2000/svg" width="210" height="500" viewBox="-5 0 90 90"><polygon fill="'+color+'" stroke="black" stroke-width="3" points="32,7,9,57,58,57" /><circle cx="32" cy="38" r="33" stroke="green" stroke-width="5" fill="transparent" /><text x="33" y="50" text-anchor="middle" fill="black" font-weight="normal" font-size="38">'+tier_no+'</text></svg>';
					}
					else if (trendCategory === "Declining"){
						var svg = '<svg xmlns="http://www.w3.org/2000/svg" width="210" height="500" viewBox="-5 0 90 90"><polygon fill="'+color+'" stroke="black" stroke-width="3" points="32,7,9,57,58,57" /><circle cx="32" cy="38" r="33" stroke="red" stroke-width="5" fill="transparent" /><text x="33" y="50" text-anchor="middle" fill="black" font-weight="normal" font-size="38">'+tier_no+'</text></svg>';
					}
					else if (filtered[row].trend === "No Growth (-4 to 4)"){
						var svg = '<svg xmlns="http://www.w3.org/2000/svg" width="210" height="500" viewBox="-5 0 90 90"><polygon fill="'+color+'" stroke="black" stroke-width="3" points="32,7,9,57,58,57" /><circle cx="32" cy="38" r="33" stroke="orange" stroke-width="5" fill="transparent" /><text x="33" y="50" text-anchor="middle" fill="black" font-weight="normal" font-size="38">'+tier_no+'</text></svg>';
					}
					else{
						var svg = '<svg xmlns="http://www.w3.org/2000/svg" width="210" height="500" viewBox="-5 0 90 90"><polygon fill="'+color+'" stroke="black" stroke-width="3" points="32,7,9,57,58,57" /><circle cx="32" cy="38" r="33" stroke="black" stroke-width="0" fill="transparent" /><text x="33" y="50" text-anchor="middle" fill="black" font-weight="normal" font-size="38">'+tier_no+'</text></svg>';
					}
					var iconUrl = 'data:image/svg+xml;base64,' + btoa(svg);
					
					var icon = L.icon({
					  iconUrl: iconUrl,
					  iconSize: [31, 31],
					  iconAnchor: [10, 9]
					});
	
					
					marker.setIcon(icon);
					//markers.push(marker);
					}	 
					
					
				}
				
				if (heatActive === true && coordsHeat.length > 0){heat = L.heatLayer(coordsHeat, {minOpacity: 0.4}).addTo(map);}
				//ciLayer = L.canvasIconLayer({}).addTo(map);
				
				
				
				
							
			}
			
			 
			 map.addLayer(drawnItems);
			 L.drawLocal.draw.toolbar.buttons.polygon = 'Draw a polygon!';
			 
			 
			 var drawControl = new L.Control.Draw({
				position: 'topright',
				 draw: {polyline: false, marker: false, circle: false, circlemarker: false},
				 edit: {
					 featureGroup: drawnItems,
					 remove: true
				 }				 
			 });
			 
			 map.addControl(drawControl);
			
			
			//function for new created polygons. Deletes previous polygon and creates new one
			
			function getWithin(e){
					//reset variables used in summary
				totTier1 = 0;
				totTier2 = 0;
				totTier3 = 0;
				totTier4 = 0;
				totLow = 0;
				totMod = 0;
				totHigh = 0;
				noTier = 0;
				noPotential = 0;
				sales2017 = 0;
				sales2018 = 0;
				
				
				if (dialog != undefined){dialog.destroy();}
				
				//end variables in summary----------
				drawnAmount =1;
				 summaryPoints=[];
			//Loop to store client data inside drawn polygon	
				 for(var row = 0; row < filtered.length; row++) {
					if (filtered[row].lat>0){
						var ptsTurf = turf.point([filtered[row].lon, filtered[row].lat]);
						
						var poly = drawnItems.toGeoJSON();
						
						if(turf.booleanWithin(ptsTurf, poly.features[0]) === true){
							summaryPoints.push(filtered[row]);
							//assign values to variables for summary
							if (filtered[row].tier === "Tier 1"){totTier1++;}
							if (filtered[row].tier === "Tier 2"){totTier2++;}
							if (filtered[row].tier === "Tier 3"){totTier3++;}
							if (filtered[row].tier === "Tier 4"){totTier4++;}
							if (filtered[row].tier === null || filtered[row].tier === "N/A"){noTier++;}
							if (filtered[row].sales_potential === null || filtered[row].sales_potential === "N/A"){noPotential++;}
							if (filtered[row].sales_potential === "Low"){totLow++;}
							if (filtered[row].sales_potential === "Moderate"){totMod++;}
							if (filtered[row].sales_potential === "High"){totHigh++;}
							sales2017 += filtered[row].sales_2017;
							sales2018 += filtered[row].sales_2018;
						}
						
					}
				}
				console.log(filtered.length);
				avg2017 = sales2017/(summaryPoints.length);
				avg2018 = sales2018/(summaryPoints.length);
				
				//display dialog box summary
				dialog = L.control.dialog({size: [380, 550], maxSize: [400, 400], anchor: [0, 250]})
                .setContent("<dl class='summary'><h2>Tier</h2><dt>No. of Tier 1 clients</dt><dd>"+totTier1+"</dd><dt>No. of Tier 2 clients</dt><dd>"+totTier2+"</dd><dt>No. of Tier 3 clients</dt><dd>"+totTier3+"</dd><dt>No. of Tier 4 clients</dt><dd>"+totTier4+"</dd><dt>No. of clients without Tier</dt><dd>"+noTier+"</dd><h2>Growth Potential</h2><dt>Low</dt><dd>"+totLow+"</dd><dt>Moderate</dt><dd>"+totMod+"</dd><dt>High</dt><dd>"+totHigh+"</dd><dt>Without growth info</dt><dd>"+noPotential+"</dd><h2>Sales</h2><dt>Total sales 2017</dt><dd>$."+numeral(sales2017).format('0,0')+"</dd><dt>Total sales 2018</dt><dd>$."+numeral(sales2018).format('0,0')+"</dd><dt>Average sales 2017</dt><dd>$"+avg2017.toFixed(2)+"</dd><dt>Average sales 2018</dt><dd>$"+avg2018.toFixed(2)+"</dd></dl><div style='text-align: center;'><button id='download'>Download selected</button></div>")
			    .addTo(map);
			    dialog.hideResize();
				//if(document.getElementById("download") == null){document.getElementById("download").id = "old";}
			    document.getElementById("download").addEventListener("click", downloadExcel);
				function downloadExcel(){
					var xls = new xlsExport(summaryPoints, 'title');
					 xls.exportToXLS('export.xls')
				};
				
				 
			};
			map.on('draw:created', function (e){
				map.removeLayer(drawnItems); drawnItems.clearLayers(); drawnItems.addLayer(e.layer); 
				// Each time a feaute is created, it's added to the over arching feature group
				 map.addLayer(drawnItems);
				 getWithin(e);
			
			});
			
			map.on('draw:edited', getWithin);
				
			map.fitBounds(pointGroupLayer.getBounds());	
			$('input[name="tier"]').click(function(e){
			drawPoints();
			
			
			$('input[name="radiotier"]').prop('checked', false);
			if (drawnAmount>0){ getWithin(e);}});
			
			$('input[name="potential"]').click(function(e){
			drawPoints();
			$('input[name="radiopotential"]').prop('checked', false);
			if (drawnAmount>0){ getWithin(e);}});
			
			$('input[name="trend"]').click(function(e){
			drawPoints();
			$('input[name="radiotrend"]').prop('checked', false);
			if (drawnAmount>0){ getWithin(e);}});
			
			
			
			$('input[value="UnselectAll"]').click(function(e){
				
				if(this.attributes["name"].value === "radiotier"){
					$('input[name="tier"]').prop('checked', false);
				}
				else if(this.attributes["name"].value === "radiotrend"){
					$('input[name="trend"]').prop('checked', false);
				}
				else{
					$('input[name="potential"]').prop('checked', false);
				}
				drawPoints();
			});
			
			$('input[value="SelectAll"]').click(function(e){
				if(this.attributes["name"].value === "radiotier"){
					$('input[name="tier"]').prop('checked', true);
				}
				else if(this.attributes["name"].value === "radiotrend"){
					$('input[name="trend"]').prop('checked', true);
				}
				else{
					$('input[name="potential"]').prop('checked', true);
				}
				drawPoints();
			});
			clusterButton.addEventListener("click", function(e){
				clusterZoom = (clusterZoom === 18) ? 0 : 18;
				drawPoints();
				console.log(clusterZoom);
			});
			heatButton.addEventListener("click", function(e){
				if (coordsHeat.length > 0 && heatActive===false){heat = L.heatLayer(coordsHeat, {minOpacity: 0.4}).addTo(map);}
				if (heatActive===true){map.removeLayer(heat);}
				heatActive = !heatActive;
				console.log(heatActive);
			});
			
			drawnItems.on('click', function(e) { //show dialog box when polygon is clicked
				if (dialog != undefined){dialog.destroy();}
				dialog = L.control.dialog({size: [380, 550], maxSize: [400, 400], anchor: [0, 250]})
                .setContent("<dl class='summary'><h2>Tier</h2><dt>No. of Tier 1 clients</dt><dd>"+totTier1+"</dd><dt>No. of Tier 2 clients</dt><dd>"+totTier2+"</dd><dt>No. of Tier 3 clients</dt><dd>"+totTier3+"</dd><dt>No. of Tier 4 clients</dt><dd>"+totTier4+"</dd><dt>No. of clients without Tier</dt><dd>"+noTier+"</dd><h2>Growth Potential</h2><dt>Low</dt><dd>"+totLow+"</dd><dt>Moderate</dt><dd>"+totMod+"</dd><dt>High</dt><dd>"+totHigh+"</dd><dt>Without growth info</dt><dd>"+noPotential+"</dd><h2>Sales</h2><dt>Total sales 2017</dt><dd>$."+numeral(sales2017).format('0,0')+"</dd><dt>Total sales 2018</dt><dd>$."+numeral(sales2018).format('0,0')+"</dd><dt>Average sales 2017</dt><dd>$"+avg2017.toFixed(2)+"</dd><dt>Average sales 2018</dt><dd>$"+avg2018.toFixed(2)+"</dd></dl><div style='text-align: center;'><button id='download'>Download selected</button></div>")
			    .addTo(map);
			    dialog.hideResize();
				//if(document.getElementById("download") == null){document.getElementById("download").id = "old";}
			    document.getElementById("download").addEventListener("click", downloadExcel);
				function downloadExcel(){
					var xls = new xlsExport(summaryPoints, 'title');
					 xls.exportToXLS('export.xls')
				};
			});
			
			
		
		
	
	
}
			
</script>



</body>
</html>
