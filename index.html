<!DOCTYPE html>
<html>
<head>
	
    <title>Clients</title>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src='https://cdnjs.cloudflare.com/ajax/libs/tabletop.js/1.5.1/tabletop.min.js'></script>

     <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"
   integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
   crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"
   integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="
   crossorigin=""></script>
    
	<!-- <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/"></script> -->

   <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

	
	<script src="https://stamen-maps.a.ssl.fastly.net/js/tile.stamen.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"/>
    <link rel="stylesheet" href="https://rawgit.com/python-visualization/folium/master/folium/templates/leaflet.awesome.rotate.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
	

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css"/>
	
	<script src="leaflet-heat.js"></script>
	<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"/>
	<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"/>
	<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
</head>
<body>




<style>
/* The sidebar menu */
.sidenav {
  height: 100%; /* Full-height: remove this if you want "auto" height */
  width: 160px; /* Set the width of the sidebar */
  position: fixed; /* Fixed Sidebar (stay in place on scroll) */
  z-index: 1; /* Stay on top */
  top: 0; /* Stay at the top */
  left: 0;
  background-color: rgba(255,255,255, 0.5);
  
  overflow-x: hidden; /* Disable horizontal scroll */
  padding-top: 20px;
}



h2{
	text-align:center;
	font-size: 14pt;
}

dl {
    border: 2px double #ccc;
    padding: 0.5em;
  }
  dt {
	
    float: left;
    clear: left;
	
    width: 100px;
   
    font-weight: bold;
    color: green;
  }
  dt::after {
    content: ":";
  }
 
  dd {
    margin: 0 0 0 100px;
    padding: 0 0 0.5em 0;
  }
.circle {
    border-radius: 50%;
    width: 20px;
    height: 20px;
    border: 1.9px solid black;
    text-align: center;
    display: table-cell;
    vertical-align: middle;

}
.circle.High   {background-color: PeachPuff}
.circle.Moderate {background-color: LightSkyBlue}
.circle.Low    {background-color: MediumOrchid}

.circle.Declining    {border-color: red}
.circle.Growing    {border-color: limegreen}

</style>
<div class="sidenav">
	<table><h2 class="filterTitle">MAH Tier</h2>	
			<tr><td><input type="checkbox" name="tier" value="Tier 1" checked=checked />Tier 1</td></tr>
			<tr><td><input type="checkbox" name="tier" value="Tier 2" checked=checked/>Tier 2</td></tr>
			<tr><td><input type="checkbox" name="tier" value="Tier 3" checked=checked/>Tier 3</td></tr>		
			<tr><td><input type="checkbox" name="tier" value="Tier 4" checked=checked/>Tier 4</td></tr>
			<tr><td><input type="checkbox" name="tier" value="null" checked=checked/>No tier</td></tr>
	</table><table>
			<h2 class="filterTitle">Growth Potential</h2>	
			<tr><td><input type="checkbox" name="potential" value="Low" checked=checked />Low</td></tr>
			<tr><td><input type="checkbox" name="potential" value="Moderate" checked=checked />Moderate</td></tr>
			<tr><td><input type="checkbox" name="potential" value="High" checked=checked />High</td></tr>
			<tr><td><input type="checkbox" name="potential" value="null" checked=checked />No value</td></tr>
	</table><table>
			<h2 class="filterTitle">Sales Trend</h2>	
			<tr><td><input type="checkbox" name="trend" value="Extreme Growth (50+)" checked=checked />Extreme Growth (50+)</td></tr>
			<tr><td><input type="checkbox" name="trend" value="Major Growth (20 to 49)" checked=checked />Major Growth (20 to 49)</td></tr>
			<tr><td><input type="checkbox" name="trend" value="Moderate Growth (5 to 19)" checked=checked />Moderate Growth (5 to 19)</td></tr>
			<tr><td><input type="checkbox" name="trend" value="No Growth (-4 to 4)" checked=checked />No Growth (-4 to 4)</td></tr>
			<tr><td><input type="checkbox" name="trend" value="No Sales" checked=checked />No Sales</td></tr>
			<tr><td><input type="checkbox" name="trend" value="Moderate Loss (-19 to -5)" checked=checked />Moderate Loss (-19 to -5)</td></tr>
			<tr><td><input type="checkbox" name="trend" value="Major Loss (-49 to -20)" checked=checked />Major Loss (-49 to -20)</td></tr>
			<tr><td><input type="checkbox" name="trend" value="Extreme Loss (-50+)" checked=checked />Extreme Loss (-50+)</td></tr>
			<tr><td><input type="checkbox" name="trend" value="null" checked=checked />No value</td></tr>
				
	</table>
			
	
</div>

<div id="map" style="width: 100vw; height: 100vh; z-index: 0;"></div>
<script>



	$.getJSON('https://api.sheety.co/d1d52423-9f56-40da-bfcf-f1cd314dacbc', function(json) {
		addPoints(json);
	});
	

	
	var map = L.map('map', {zoomControl: false}).setView([35, -99], 4);
	
	//var tonerLayer = new L.StamenTileLayer("watercolor");
	//map.addLayer(tonerLayer);
	
	var Esri_WorldStreetMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
	attribution: 'Tiles &copy; Esri &mdash; Source: Esri, DeLorme, NAVTEQ, USGS, Intermap, iPC, NRCAN, Esri Japan, METI, Esri China (Hong Kong), Esri (Thailand), TomTom, 2012'
	});
	Esri_WorldStreetMap.addTo(map);
	
	
	var pointGroupLayer;
	
	function addPoints(data) {
	if (pointGroupLayer != null) {
		pointGroupLayer.remove();
	}
	
	
	var clusters = L.markerClusterGroup({ disableClusteringAtZoom: 15 });
	pointGroupLayer = L.featureGroup();
	
	var clicks = 0; //click counter for filters
	var heat;
	drawPoints();
	function drawPoints(){      //function called when a checkbox is clicked
		
		coordsHeat = []; //define an array to store coordinates
		
		if (clicks > 0){map.removeLayer(heat); clusters.clearLayers();}
			clicks++;
			
		//map.removeLayer(pointGroupLayer)
		//pointGroupLayer = L.featureGroup().addTo(map);
		//filters---------------
		tierfilter = [];
		potentialfilter = [];
		trendfilter = [];
		
		 //--------tier filter-----
		$("input:checkbox[name='tier']:checked").each(function(){
				//tierfilter=[];
			if($(this).val() === "null"){tierfilter.push(null);}
			else{
			tierfilter.push($(this).val());}});
			
		function tierFilter(element) {
			var valid = tierfilter;
			return (valid.includes(element.tier));
		}
			//-----growth potential filter----
		$("input:checkbox[name='potential']:checked").each(function(){ 
			if($(this).val() === "null" || $(this).val() === "N/A"){potentialfilter.push(null);}
			else{
			potentialfilter.push($(this).val());}});
				
		function potentialFilter(element) {
			var valid = potentialfilter;
			return (valid.includes(element.sales_potential));
		}
			//-----sales trend filter----
		$("input:checkbox[name='trend']:checked").each(function(){ 
			if($(this).val() === "null" || $(this).val() === "N/A"){trendfilter.push(null);}
			else{
			trendfilter.push($(this).val());}});
				
		function trendFilter(element) {
			var valid = trendfilter;
			return (valid.includes(element.trend));
		}
		
		var filtered = data.filter(tierFilter);
		filtered = data.filter(potentialFilter);
		filtered = data.filter(trendFilter);
		
		
		
		//--------------------------------------------------
		for(var row = 0; row < filtered.length; row++) {
			if (filtered[row].lat>0){
					
					if(filtered[row].tier != null){var index = filtered[row].tier.indexOf(" ");
					var tier_no = filtered[row].tier.substr(index + 1);}else{var tier_no = "0"}
					tier_no = parseInt(tier_no);
					
					
					coordsHeat.push([filtered[row].lat, filtered[row].lon]);
					var marker = L.marker([filtered[row].lat, filtered[row].lon]).addTo(pointGroupLayer);
					marker.bindPopup("<dl>" + "<h2>Client Information	</h2><dt>Client Name </dt><dd>" + filtered[row].client + "</dd><dt>Address </dt><dd>"+ filtered[row].address+  "</dd><dt>2017 Sales </dt><dd>" + filtered[row].sales_2017 + "</dd><dt>2018 Sales </dt><dd>" + filtered[row].sales_2018 +"</dd><dt>Sales Trend </dt><dd>" + filtered[row].trend + "</dd><dt>Tier </dt><dd>" + filtered[row].tier_no+ "</dd><dt>Sales Potential </dt><dd>" +  filtered[row].sales_potential + "</dd></dl>", 
					{
					maxWidth: 380,
					maxHeight: 700
					
					}); 
					
					
					clusters.addLayer(marker);
					map.addLayer(clusters);
					// icon
					
					var icon = L.divIcon({
						className: "my-div-icon",
						iconSize: [20, 20],
						html: "<div class='circle "+filtered[row].sales_potential+" "+filtered[row].trend+"'><b>"+tier_no+"</b></div>"
					});
					
					marker.setIcon(icon);
						
					}	 
					
					
				}
				
				if (coordsHeat.length > 0){heat = L.heatLayer(coordsHeat, {minOpacity: 0.4}).addTo(map);}
				console.log(coordsHeat.length);
				
				
					
			
			
			
			}
		
			
			map.fitBounds(pointGroupLayer.getBounds());	
			$('input[name="tier"]').click(drawPoints);
			$('input[name="potential"]').click(drawPoints);
			$('input[name="trend"]').click(drawPoints);
			
		
		
		
	
	
	
}


			
</script>



</body>
</html>
