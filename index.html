<!DOCTYPE html>
<html>
<head>
	
    <title>Clients</title>

    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src='https://cdnjs.cloudflare.com/ajax/libs/tabletop.js/1.5.1/tabletop.min.js'></script>

     <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css"
   integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
   crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"
   integrity="sha512-GffPMF3RvMeYyc1LWMHtK8EbPv0iNZ8/oTtHPx9/cc2ILxQ+u905qIwdpULaqDkyBKgOaB57QTMg7ztg8Jm2Og=="
   crossorigin=""></script>
    
	<!-- <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/"></script> -->

   <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>

	
	<script src="https://stamen-maps.a.ssl.fastly.net/js/tile.stamen.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.css"/>
    <link rel="stylesheet" href="https://rawgit.com/python-visualization/folium/master/folium/templates/leaflet.awesome.rotate.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Leaflet.awesome-markers/2.0.2/leaflet.awesome-markers.js"></script>
	

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css"/>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css"/>
	
	<script src="script/leaflet-heat.js"></script>
	<link rel="stylesheet" href="script/Leaflet.Dialog.css"/>
	<script src="script/Leaflet.Dialog.js"></script>
	
	
	
	<script src=https://cdnjs.cloudflare.com/ajax/libs/Turf.js/5.1.5/turf.min.js></script>
	
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
	
	
	
	<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"/>
	<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"/>
	<script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
	
	<script src="https://cdnjs.cloudflare.com/ajax/libs/numeral.js/2.0.6/numeral.min.js"></script>
	<script src="script/xls-export.js"></script>
</head>
<body>




<style>
/* The sidebar menu */
.sidenav {
  height: 100%; /* Full-height: remove this if you want "auto" height */
  width: 240px; /* Set the width of the sidebar */
  position: fixed; /* Fixed Sidebar (stay in place on scroll) */
  z-index: 1; /* Stay on top */
  top: 0; /* Stay at the top */
  left: 0;
  background-color: rgba(255,255,255, 0.5);
  
  overflow-x: hidden; /* Disable horizontal scroll */
  padding-top: 8px;
}

.summary > dt{
	float: left;
    clear: left;
	
    width: 160px;
   
    font-weight: bold;
    color: black;

}

h2{
	text-align:center;
	font-size: 14pt;
}

dl {
    border: 1.5px double #ccc;
    padding: 0.2em;
	
  }
  dt {
	
    float: left;
    clear: left;
	
    width: 100px;
   
    font-weight: bold;
    color: green;
  }
  dt::after {
    content: ":";
  }
 
  dd {
    margin: 0 0 0 100px;
    padding: 0 0 0.5em 0;
  }
.circle {
    border-radius: 0%;
    width: 20px;
    height: 20px;
    border: 1.9px solid black;
    text-align: center;
    display: table-cell;
    vertical-align: middle;

}
.circle.High   {background-color: PeachPuff}
.circle.Moderate {background-color: LightSkyBlue}
.circle.Low    {background-color: MediumOrchid}

.circle.Declining    {border-color: red}
.circle.Growing    {border-color: Lime}

</style>
<div class="sidenav">
	<table><h2 class="filterTitle">MAH Tier</h2>	
			<tr><td><input type="checkbox" name="tier" value="Tier 1" checked=checked />Tier 1</td></tr>
			<tr><td><input type="checkbox" name="tier" value="Tier 2" checked=checked/>Tier 2</td></tr>
			<tr><td><input type="checkbox" name="tier" value="Tier 3" checked=checked/>Tier 3</td></tr>		
			<tr><td><input type="checkbox" name="tier" value="Tier 4" checked=checked/>Tier 4</td></tr>
			<tr><td><input type="checkbox" name="tier" value="null" checked=checked/>No tier</td></tr>
			<tr><td></tr></td>
			<tr><td><input type="radio" name="radiotier" value="SelectAll"/>Select All</tr></td>
			<tr><td><input type="radio" name="radiotier" value="UnselectAll"/>Unselect All</tr></td>
	</table><table>
			<h2 class="filterTitle">Growth Potential</h2>	
			<tr><td><input type="checkbox" name="potential" value="Low" checked=checked />Low</td></tr>
			<tr><td><input type="checkbox" name="potential" value="Moderate" checked=checked />Moderate</td></tr>
			<tr><td><input type="checkbox" name="potential" value="High" checked=checked />High</td></tr>
			<tr><td><input type="checkbox" name="potential" value="null" checked=checked />No value</td></tr>
			<tr><td></tr></td>
			<tr><td><input type="radio" name="radiopotential" value="SelectAll"/>Select All</tr></td>
			<tr><td><input type="radio" name="radiopotential" value="UnselectAll"/>Unselect All</tr></td>
	</table><table>
			<h2 class="filterTitle">Sales Trend</h2>	
			<tr><td><input type="checkbox" name="trend" value="Extreme Growth (50+)" checked=checked />Extreme Growth (50+)</td></tr>
			<tr><td><input type="checkbox" name="trend" value="Major Growth (20 to 49)" checked=checked />Major Growth (20 to 49)</td></tr>
			<tr><td><input type="checkbox" name="trend" value="Moderate Growth (5 to 19)" checked=checked />Moderate Growth (5 to 19)</td></tr>
			<tr><td><input type="checkbox" name="trend" value="No Growth (-4 to 4)" checked=checked />No Growth (-4 to 4)</td></tr>
			<tr><td><input type="checkbox" name="trend" value="No Sales" checked=checked />No Sales</td></tr>
			<tr><td><input type="checkbox" name="trend" value="Moderate Loss (-19 to -5)" checked=checked />Moderate Loss (-19 to -5)</td></tr>
			<tr><td><input type="checkbox" name="trend" value="Major Loss (-49 to -20)" checked=checked />Major Loss (-49 to -20)</td></tr>
			<tr><td><input type="checkbox" name="trend" value="Extreme Loss (-50+)" checked=checked />Extreme Loss (-50+)</td></tr>
			<tr><td><input type="checkbox" name="trend" value="null" checked=checked />No value</td></tr>
			<tr><td></tr></td>
			<tr><td><input type="radio" name="radiotrend" value="SelectAll"/>Select All</tr></td>
			<tr><td><input type="radio" name="radiotrend" value="UnselectAll"/>Unselect All</tr></td>
				
	</table>
			
	
</div>

<div id="map" style="width: 100vw; height: 100vh; z-index: 0;"></div>
<script>



	$.getJSON('https://api.sheety.co/d1d52423-9f56-40da-bfcf-f1cd314dacbc', function(json) {
		addPoints(json);
	});
	

	
	var map = L.map('map', {zoomControl: true}).setView([35, -99], 4);
	map.zoomControl.setPosition('bottomright');
	//var tonerLayer = new L.StamenTileLayer("watercolor");
	//map.addLayer(tonerLayer);
	
	var Esri_WorldStreetMap = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}', {
	attribution: 'Tiles &copy; Esri &mdash; Source: Esri, DeLorme, NAVTEQ, USGS, Intermap, iPC, NRCAN, Esri Japan, METI, Esri China (Hong Kong), Esri (Thailand), TomTom, 2012'
	});
	Esri_WorldStreetMap.addTo(map);
	
	
	var pointGroupLayer;
	
	function addPoints(data) {
	if (pointGroupLayer != null) {
		pointGroupLayer.remove();
	}
	
	
	var clusters = L.markerClusterGroup({ disableClusteringAtZoom: 15 });
	pointGroupLayer = L.featureGroup();
	
	var clicks = 0; //click counter for filters
	var heat;
	var filtered = new Array();
	var summaryPoints = new Array(); //array with the points within the drawn polygon
	drawPoints();
	var drawnItems = new L.FeatureGroup();
	//map.addLayer(drawnItems);
	
	//variables used in summary
				var totTier1 = 0;
				var totTier2 = 0;
				var totTier3 = 0;
				var totTier4 = 0;
				var noTier = 0;
				var totLow = 0;
				var totMod = 0;
				var totHigh = 0;
				var noPotential = 0;
				var sales2017 = 0;
				var avg2017 = 0;
				var sales2018 = 0;
				var avg2018 = 0;
				
				//end variables in summary----------
	
	var dialog;
	var drawnAmount = 0;
	function drawPoints(){      //function called when a checkbox is clicked
		
		coordsHeat = []; //define an array to store coordinates
		
		if (clicks > 0){map.removeLayer(heat); clusters.clearLayers();}
			clicks++;
			
		//map.removeLayer(pointGroupLayer)
		//pointGroupLayer = L.featureGroup().addTo(map);
		//filters---------------
		tierfilter = [];
		potentialfilter = [];
		trendfilter = [];
		
		 //--------tier filter-----
		$("input:checkbox[name='tier']:checked").each(function(){
				//tierfilter=[];
			if($(this).val() === "null"){tierfilter.push(null);}
			else{
			tierfilter.push($(this).val());}});
			
		function tierFilter(element) {
			var valid = tierfilter;
			return (valid.includes(element.tier));
		}
			//-----growth potential filter----
		$("input:checkbox[name='potential']:checked").each(function(){ 
			if($(this).val() === "null" || $(this).val() === "N/A"){potentialfilter.push(null);}
			else{
			potentialfilter.push($(this).val());}});
				
		function potentialFilter(element) {
			var valid = potentialfilter;
			return (valid.includes(element.sales_potential));
		}
			//-----sales trend filter----
		$("input:checkbox[name='trend']:checked").each(function(){ 
			if($(this).val() === "null" || $(this).val() === "N/A"){trendfilter.push(null);}
			else{
			trendfilter.push($(this).val());}});
				
		function trendFilter(element) {
			var valid = trendfilter;
			return (valid.includes(element.trend));
		}
		
		filtered = data.filter(tierFilter);
		filtered = filtered.filter(potentialFilter);
		filtered = filtered.filter(trendFilter);
		
		
		
		//--------------------------------------------------
		for(var row = 0; row < filtered.length; row++) {
			if (filtered[row].lat > 0){
					
					if(filtered[row].tier != null){var index = filtered[row].tier.indexOf(" ");
					var tier_no = filtered[row].tier.substr(index + 1);}else{var tier_no = "0"}
					tier_no = parseInt(tier_no);
					
					
					coordsHeat.push([filtered[row].lat, filtered[row].lon]);
					var marker = L.marker([filtered[row].lat, filtered[row].lon]).addTo(pointGroupLayer);
					marker.bindPopup("<dl>" + "<h2>Client Information	</h2><dt>Client Name </dt><dd>" + filtered[row].client + "</dd><dt>Address </dt><dd>"+ filtered[row].address+  "</dd><dt>2017 Sales </dt><dd>$." + numeral(filtered[row].sales_2017).format('0,0') + "</dd><dt>2018 Sales </dt><dd>$." + numeral(filtered[row].sales_2018).format('0,0') +"</dd><dt>Sales Trend </dt><dd>" + filtered[row].trend + "</dd><dt>Tier </dt><dd>" +tier_no+ "</dd><dt>Sales Potential </dt><dd>" +  filtered[row].sales_potential + "</dd></dl>", 
					{
					maxWidth: 380,
					maxHeight: 700
					
					}); 
					
					
					clusters.addLayer(marker);
					map.addLayer(clusters);
					var trendCategory;
					// icon
					if(filtered[row].trend === "Extreme Growth (50+)" || filtered[row].trend === "Major Growth (20 to 49)" || filtered[row].trend ===  "Moderate Growth (5 to 19)"){trendCategory = 'Growing';}
					else if(filtered[row].trend === "Moderate Loss (-19 to -5)" || filtered[row].trend === "Major Loss (-49 to -20)" || filtered[row].trend === "Extreme Loss (-50+)"){trendCategory = 'Declining';}
					else{trendCategory="";}
					var icon = L.divIcon({
						className: "my-div-icon",
						iconSize: [20, 20],
						html: "<div class='circle "+filtered[row].sales_potential+" "+trendCategory+"'><b>"+tier_no+"</b></div>"
					});
					
					marker.setIcon(icon);
						
					}	 
					
					
				}
				
				if (coordsHeat.length > 0){heat = L.heatLayer(coordsHeat, {minOpacity: 0.4}).addTo(map);}
				
				
				
					
			
			
			
			}
			
			 
			 map.addLayer(drawnItems);
			 L.drawLocal.draw.toolbar.buttons.polygon = 'Draw a polygon!';
			 
			 
			 var drawControl = new L.Control.Draw({
				position: 'topright',
				 draw: {polyline: false, marker: false, circle: false, circlemarker: false},
				 edit: {
					 featureGroup: drawnItems,
					 remove: true
				 }				 
			 });
			 
			 map.addControl(drawControl);
			
			
			//function for new created polygons. Deletes previous polygon and creates new one
			
			function getWithin(e){
					//reset variables used in summary
				totTier1 = 0;
				totTier2 = 0;
				totTier3 = 0;
				totTier4 = 0;
				totLow = 0;
				totMod = 0;
				totHigh = 0;
				noTier = 0;
				noPotential = 0;
				sales2017 = 0;
				sales2018 = 0;
				
				
				if (dialog != undefined){dialog.destroy();}
				
				//end variables in summary----------
				drawnAmount =1;
				 summaryPoints=[];
			//Loop to store client data inside drawn polygon	
				 for(var row = 0; row < filtered.length; row++) {
					if (filtered[row].lat>0){
						var ptsTurf = turf.point([filtered[row].lon, filtered[row].lat]);
						
						var poly = drawnItems.toGeoJSON();
						
						if(turf.booleanWithin(ptsTurf, poly.features[0]) === true){
							summaryPoints.push(filtered[row]);
							//assign values to variables for summary
							if (filtered[row].tier === "Tier 1"){totTier1++;}
							if (filtered[row].tier === "Tier 2"){totTier2++;}
							if (filtered[row].tier === "Tier 3"){totTier3++;}
							if (filtered[row].tier === "Tier 4"){totTier4++;}
							if (filtered[row].tier === null || filtered[row].tier === "N/A"){noTier++;}
							if (filtered[row].sales_potential === null || filtered[row].sales_potential === "N/A"){noPotential++;}
							if (filtered[row].sales_potential === "Low"){totLow++;}
							if (filtered[row].sales_potential === "Moderate"){totMod++;}
							if (filtered[row].sales_potential === "High"){totHigh++;}
							sales2017 += filtered[row].sales_2017;
							sales2018 += filtered[row].sales_2018;
						}
						
					}
				}
				console.log(filtered.length);
				avg2017 = sales2017/(summaryPoints.length);
				avg2018 = sales2018/(summaryPoints.length);
				
				//display dialog box summary
				dialog = L.control.dialog({size: [380, 550], maxSize: [400, 400], anchor: [0, 250]})
                .setContent("<dl class='summary'><h2>Tier</h2><dt>No. of Tier 1 clients</dt><dd>"+totTier1+"</dd><dt>No. of Tier 2 clients</dt><dd>"+totTier2+"</dd><dt>No. of Tier 3 clients</dt><dd>"+totTier3+"</dd><dt>No. of Tier 4 clients</dt><dd>"+totTier4+"</dd><dt>No. of clients without Tier</dt><dd>"+noTier+"</dd><h2>Growth Potential</h2><dt>Low</dt><dd>"+totLow+"</dd><dt>Moderate</dt><dd>"+totMod+"</dd><dt>High</dt><dd>"+totHigh+"</dd><dt>Without growth info</dt><dd>"+noPotential+"</dd><h2>Sales</h2><dt>Total sales 2017</dt><dd>$."+numeral(sales2017).format('0,0')+"</dd><dt>Total sales 2018</dt><dd>$."+numeral(sales2018).format('0,0')+"</dd><dt>Average sales 2017</dt><dd>$"+avg2017.toFixed(2)+"</dd><dt>Average sales 2018</dt><dd>$"+avg2018.toFixed(2)+"</dd></dl><div style='text-align: center;'><button id='download'>Download selected</button></div>")
			    .addTo(map);
			    dialog.hideResize();
				//if(document.getElementById("download") == null){document.getElementById("download").id = "old";}
			    document.getElementById("download").addEventListener("click", downloadExcel);
				function downloadExcel(){
					var xls = new xlsExport(summaryPoints, 'title');
					 xls.exportToXLS('export.xls')
				};
				
				 
			};
			map.on('draw:created', function (e){
				map.removeLayer(drawnItems); drawnItems.clearLayers(); drawnItems.addLayer(e.layer); 
				// Each time a feaute is created, it's added to the over arching feature group
				 map.addLayer(drawnItems);
				 getWithin(e);
			
			});
			
			map.on('draw:edited', getWithin);
				
			map.fitBounds(pointGroupLayer.getBounds());	
			$('input[name="tier"]').click(function(e){
			drawPoints();
			$('input[name="radiotier"]').prop('checked', false);
			if (drawnAmount>0){ getWithin(e);}});
			
			$('input[name="potential"]').click(function(e){
			drawPoints();
			$('input[name="radiopotential"]').prop('checked', false);
			if (drawnAmount>0){ getWithin(e);}});
			
			$('input[name="trend"]').click(function(e){
			drawPoints();
			$('input[name="radiotrend"]').prop('checked', false);
			if (drawnAmount>0){ getWithin(e);}});
			
			
			
			$('input[value="UnselectAll"]').click(function(e){
				
				if(this.attributes["name"].value === "radiotier"){
					$('input[name="tier"]').prop('checked', false);
				}
				else if(this.attributes["name"].value === "radiotrend"){
					$('input[name="trend"]').prop('checked', false);
				}
				else{
					$('input[name="potential"]').prop('checked', false);
				}
				drawPoints();
			});
			
			$('input[value="SelectAll"]').click(function(e){

				if(this.attributes["name"].value === "radiotier"){
					$('input[name="tier"]').prop('checked', true);
				}
				else if(this.attributes["name"].value === "radiotrend"){
					$('input[name="trend"]').prop('checked', true);
				}
				else{
					$('input[name="potential"]').prop('checked', true);
				}
				drawPoints();
			});
			
			
			drawnItems.on('click', function(e) { //show dialog box when polygon is clicked
				if (dialog != undefined){dialog.destroy();}
				dialog = L.control.dialog({size: [380, 550], maxSize: [400, 400], anchor: [0, 250]})
                .setContent("<dl class='summary'><h2>Tier</h2><dt>No. of Tier 1 clients</dt><dd>"+totTier1+"</dd><dt>No. of Tier 2 clients</dt><dd>"+totTier2+"</dd><dt>No. of Tier 3 clients</dt><dd>"+totTier3+"</dd><dt>No. of Tier 4 clients</dt><dd>"+totTier4+"</dd><dt>No. of clients without Tier</dt><dd>"+noTier+"</dd><h2>Growth Potential</h2><dt>Low</dt><dd>"+totLow+"</dd><dt>Moderate</dt><dd>"+totMod+"</dd><dt>High</dt><dd>"+totHigh+"</dd><dt>Without growth info</dt><dd>"+noPotential+"</dd><h2>Sales</h2><dt>Total sales 2017</dt><dd>$."+numeral(sales2017).format('0,0')+"</dd><dt>Total sales 2018</dt><dd>$."+numeral(sales2018).format('0,0')+"</dd><dt>Average sales 2017</dt><dd>$"+avg2017.toFixed(2)+"</dd><dt>Average sales 2018</dt><dd>$"+avg2018.toFixed(2)+"</dd></dl><div style='text-align: center;'><button id='download'>Download selected</button></div>")
			    .addTo(map);
			    dialog.hideResize();
				//if(document.getElementById("download") == null){document.getElementById("download").id = "old";}
			    document.getElementById("download").addEventListener("click", downloadExcel);
				function downloadExcel(){
					var xls = new xlsExport(summaryPoints, 'title');
					 xls.exportToXLS('export.xls')
				};
			});
			
			
		
	
	
	
}


			
</script>



</body>
</html>
